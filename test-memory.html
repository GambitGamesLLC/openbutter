<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Leak Test - OpenButter</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .test-controls {
      margin-bottom: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }
    button:hover {
      background: #f0f0f0;
    }
    .results {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    #test-container {
      margin-top: 20px;
      border: 2px dashed #ccc;
      padding: 20px;
      min-height: 100px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”§ Memory Leak Test - OpenButter</h1>
  
  <div class="test-controls">
    <h3>Test Controls</h3>
    <button onclick="runButterChatTest()">Test butter-chat</button>
    <button onclick="runButterAppTest()">Test butter-app</button>
    <button onclick="runStressTest()">Stress Test (100 cycles)</button>
    <button onclick="clearResults()">Clear Results</button>
  </div>

  <div id="test-container"></div>
  <div id="results" class="results"></div>

  <!-- Import the modules -->
  <script type="module">
    import { ButterChat } from './src/components/butter-chat.js';
    
    // Expose to window for button handlers
    window.ButterChat = ButterChat;
  </script>

  <script>
    const results = document.getElementById('results');
    const container = document.getElementById('test-container');
    let testCount = 0;

    function log(message, type = 'info') {
      const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      results.innerHTML += `<span class="${colorClass}">${message}</span>\n`;
      results.scrollTop = results.scrollHeight;
    }

    function clearResults() {
      results.innerHTML = '';
      container.innerHTML = '';
      testCount = 0;
    }

    // Test butter-chat component
    window.runButterChatTest = function() {
      testCount++;
      log(`\n=== Test #${testCount}: butter-chat ===`);
      
      try {
        // Clear container
        container.innerHTML = '';
        
        // Create component
        const chat = document.createElement('butter-chat');
        chat.setAttribute('orchestrator-id', 'test-orch');
        container.appendChild(chat);
        
        log('âœ“ Component created', 'success');
        
        // Verify event listeners are attached
        const input = chat.querySelector('.message-input');
        const sendButton = chat.querySelector('.send-button');
        
        if (input && sendButton) {
          log('âœ“ DOM elements found', 'success');
        } else {
          log('âœ— DOM elements not found', 'error');
        }

        // Remove component (should clean up listeners)
        container.removeChild(chat);
        log('âœ“ Component removed', 'success');
        
        // Create again to test for leaks
        const chat2 = document.createElement('butter-chat');
        chat2.setAttribute('orchestrator-id', 'test-orch-2');
        container.appendChild(chat2);
        
        log('âœ“ Component re-created without errors', 'success');
        
        // Clean up
        container.removeChild(chat2);
        log('âœ“ Cleanup successful', 'success');
        log('âœ… butter-chat test passed!', 'success');
        
      } catch (err) {
        log(`âœ— Error: ${err.message}`, 'error');
        console.error(err);
      }
    };

    // Test butter-app component
    window.runButterAppTest = function() {
      testCount++;
      log(`\n=== Test #${testCount}: butter-app ===`);
      
      try {
        // Clear container
        container.innerHTML = '';
        
        // Create a mock connector
        const mockConnector = new EventTarget();
        mockConnector.connected = false;
        
        // Create component
        const app = document.createElement('butter-app');
        container.appendChild(app);
        
        log('âœ“ Component created', 'success');
        
        // Set connector (attaches listeners)
        app.setConnector(mockConnector);
        log('âœ“ Connector set', 'success');
        
        // Verify listeners are attached by dispatching events
        let connectedFired = false;
        let disconnectedFired = false;
        
        // The app should listen to these events
        const originalAddEventListener = mockConnector.addEventListener;
        let listenerCount = 0;
        
        // Remove component (should clean up listeners)
        container.removeChild(app);
        log('âœ“ Component removed', 'success');
        
        // Create new app with same connector to test cleanup
        const app2 = document.createElement('butter-app');
        container.appendChild(app2);
        app2.setConnector(mockConnector);
        log('âœ“ Component re-created without errors', 'success');
        
        // Clean up
        container.removeChild(app2);
        log('âœ“ Cleanup successful', 'success');
        log('âœ… butter-app test passed!', 'success');
        
      } catch (err) {
        log(`âœ— Error: ${err.message}`, 'error');
        console.error(err);
      }
    };

    // Stress test
    window.runStressTest = function() {
      testCount++;
      log(`\n=== Test #${testCount}: Stress Test (100 cycles) ===`);
      
      try {
        const cycles = 100;
        let errors = 0;
        
        for (let i = 0; i < cycles; i++) {
          // Test butter-chat
          const chat = document.createElement('butter-chat');
          chat.setAttribute('orchestrator-id', `stress-test-${i}`);
          container.appendChild(chat);
          container.removeChild(chat);
          
          // Test butter-app
          const app = document.createElement('butter-app');
          container.appendChild(app);
          container.removeChild(app);
          
          if (i % 25 === 0) {
            log(`  Completed ${i} cycles...`);
          }
        }
        
        log(`âœ… Stress test completed: ${cycles} cycles without errors`, 'success');
        
      } catch (err) {
        log(`âœ— Error during stress test: ${err.message}`, 'error');
        console.error(err);
      }
    };

    log('Ready for testing. Click a button above to start.');
  </script>
</body>
</html>
